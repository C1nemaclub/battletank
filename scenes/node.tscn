[gd_scene load_steps=6 format=3 uid="uid://fyequ4f1aquu"]

[ext_resource type="PackedScene" uid="uid://sfvxdg5pvsmx" path="res://scenes/enemy.tscn" id="3_b1hlc"]
[ext_resource type="PackedScene" uid="uid://d4erfgrh6cxdl" path="res://scenes/hud.tscn" id="4_fmv27"]
[ext_resource type="PackedScene" uid="uid://brnn110syfndy" path="res://scenes/player.tscn" id="4_ghxac"]

[sub_resource type="GDScript" id="GDScript_resip"]
script/source = "class_name GameManager;

extends Node

@onready var main_gun = $Node2D/MainGun
@export var enemyTriangle: PackedScene;
@export var player: PackedScene;
@export var countdownSeconds: float = 5.0;
var score = 0;
var can_spawn = true
var is_game_live = false;
var enemy_quantity = 2;
var cursor = preload(\"res://assets/Crosshair 2.png\")
# Called when the node enters the scene tree for the first time.
func _ready():
	#Input.set_custom_mouse_cursor(cursor)
	Input.set_custom_mouse_cursor(cursor, Input.CURSOR_ARROW)
	$CountdownTimer.connect(\"timeout\", onTimerCountdown)
	var enemy = get_node(\"Enemy\")
	if (!is_instance_valid(enemyTriangle)):
		print(\"No instance selected\")

func onTimerCountdown():
	countdownSeconds -= 1.0;
	$HUD.updateCountdown(countdownSeconds);
	if(countdownSeconds <= 0):
		$CountdownTimer.disconnect(\"timeout\", onTimerCountdown);
		is_game_live = true

# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
	if(!can_spawn or !is_game_live):
		return;
	
	for x in enemy_quantity:
		spawnEnemy()
	
	can_spawn = false;
	await get_tree().create_timer(1).timeout
	can_spawn = true


func _on_area_2d_2_body_entered(body):
	print(\"body\", body)
	pass # Replace with function body.


func _on_area_2d_2_area_entered(area):
	print(\"area\", area)
	pass # Replace with function body.

func spawnEnemy():
	print(\"Spawning Enemy\")
	var enemy = enemyTriangle.instantiate()
	enemy.global_position = Vector2(randi_range(0, 800), randi_range(0, 800))
	
	add_child(enemy)
	enemy.connect(\"death\", enemyDeath);
	
func enemyDeath(points):
	updateScore(points)
	

func _on_player_on_kill(killPoints):
	score += killPoints;
	$HUD.updateScore(score)

func updateScore(points):
	score += points;
	$HUD.updateScore(score)


func _on_player_player_death():
	is_game_live = false;
	$HUD.gameOver()

func _on_hud_reset_game():
	#self.reset()
	score = 0;
	updateScore(score);
	is_game_live = true;
	$HUD.gameStart();
	$Player.start(Vector2(500, 500));
	
func reset():
	score = 0
	updateScore(score)
	
	var _player = player.instantiate()
	_player.global_position = Vector2(500, 500)
	add_child(_player)
	is_game_live = true;
	$HUD.gameStart()
	
"

[sub_resource type="Environment" id="Environment_5a1tr"]
background_mode = 3
tonemap_mode = 3
ssao_radius = 14.02
glow_enabled = true
glow_levels/1 = 16.0
glow_levels/2 = 5.18
glow_levels/3 = 0.0
glow_levels/4 = 6.12
glow_levels/5 = 4.29
glow_levels/6 = 4.06
glow_levels/7 = 6.36
glow_intensity = 0.54
glow_strength = 0.76
glow_blend_mode = 0
glow_hdr_threshold = 0.18
glow_hdr_scale = 0.11
glow_hdr_luminance_cap = 64.06
glow_map_strength = 0.33
fog_enabled = true
fog_light_color = Color(0.690196, 0.521569, 0.0823529, 1)
fog_light_energy = 4.34
fog_sun_scatter = 12.05
fog_density = 0.401
fog_sky_affect = 0.41
fog_height = 38.1

[node name="GameManager" type="Node"]
script = SubResource("GDScript_resip")
enemyTriangle = ExtResource("3_b1hlc")
player = ExtResource("4_ghxac")

[node name="ColorRect" type="ColorRect" parent="."]
modulate = Color(0.34902, 0.34902, 0.34902, 1)
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = -866.0
offset_top = -642.0
offset_right = 690.0
offset_bottom = 528.0
grow_horizontal = 2
grow_vertical = 2
color = Color(0.164706, 0.317647, 0.494118, 1)

[node name="Polygon2D" type="Polygon2D" parent="."]
color = Color(0.0431373, 0.0705882, 0.133333, 1)
polygon = PackedVector2Array(-859, -644, 1844, -640, 1848, 1176, -859, 1184)

[node name="Polygon2D" type="Polygon2D" parent="Polygon2D"]
color = Color(0.564706, 0.243137, 0.262745, 1)
polygon = PackedVector2Array(1840, -632, 2124, -861, -1042, -883, -1041, 1372, 2151, 1417, 2129, -868, 1846, -635, 1855, 1166, -848, 1184, -840, -648)

[node name="StaticBody2D" type="StaticBody2D" parent="Polygon2D/Polygon2D"]

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="Polygon2D/Polygon2D/StaticBody2D"]
visible = false
modulate = Color(0.552941, 0.552941, 0.552941, 1)
polygon = PackedVector2Array(1849, -646, -1039, -890, -1039, 1378, 2165, 1406, 2133, -870, 1853, -638, 1861, 1162, -843, 1178, -826, -674)

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource("Environment_5a1tr")

[node name="Player" parent="." instance=ExtResource("4_ghxac")]
position = Vector2(500, 341)
MOVE_SPEED = 3

[node name="HUD" parent="." instance=ExtResource("4_fmv27")]

[node name="CountdownTimer" type="Timer" parent="."]
autostart = true

[connection signal="onKill" from="Player" to="." method="_on_player_on_kill"]
[connection signal="playerDeath" from="Player" to="." method="_on_player_player_death"]
[connection signal="reset_game" from="HUD" to="." method="_on_hud_reset_game"]
